<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
        integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

    <style>
        .nvtooltip {
            margin-top: -50px;
        }

        #title {
            padding-top: 20px;
        }

        .cropping_pie svg {
            height: 300px;
            width: 100%;
        }

        .crop_c_Breeding {
            background-color: #8ebf3f;
            cursor: pointer;
        }

        .crop_c_Growing {
            background-color: #cad32b;
            cursor: pointer;
        }

        .crop_c_Harvesting {
            background-color: #f5d226;
            cursor: pointer;
        }

        .crop_c_Planting {
            background-color: #f68b33;
            cursor: pointer;
        }

        .climatology_plot {
            height: 500px;
            width: 100%;
        }

        .indicator_plot {
            height: 500px;
            width: 100%;
        }

        .indicator_map {
            height: 500px;
            width: 100%;
        }

        #map_scale {
            width: 100px;
            height: 50px;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }

        .info {
            padding: 6px 8px;

            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .cell_green {
            background-color: #eaf1dd;
        }

        .cell_yellow {
            background-color: #fdfed0;
        }

        .cell_orange {
            background-color: #fde9d9;
        }

        .cell_red {
            background-color: #ffb3b3;
        }

        .practices_img_icons {
            height: 60px;
            width: 60px;
        }

        .practices_item {
            background-color: #cccccc;
            padding: 12px 12px 12px;
        }

        .practices_border {
            border-width: 1px;
            border-style: solid;
            border-color: #ffffff;
        }

        .practices_table {
            border: 1px solid #ffffff;
        }

        .borderless td,
        .borderless th {
            border: none;
        }

        table.table-bordered {
            border: 1px solid #ffffff;
            margin-top: 20px;
        }

        table.table-bordered>thead>tr>th {
            border: 1px solid #ffffff;
        }

        table.table-bordered>tbody>tr>td {
            border: 1px solid #ffffff;
        }

        .practices_id {
            font-size: 70px;
            color: #e8e8e8;
            font-weight: 900;
        }
    </style>

    <title>Pakistan</title>
</head>

<body class="d-flex flex-column h-100">
    <header>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <a class="navbar-brand" href="#">Pakistan</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('intro')">
                            <i class="fas fa-book"></i>
                            Intro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('site')">
                            <i class="fas fa-globe-asia"></i>
                            Site selection
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('cropping')">
                            <i class="fab fa-envira"></i>
                            Cropping system
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('climate')">
                            <i class="fas fa-cloud-sun-rain"></i>
                            Climate
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('risk')">
                            <i class="fas fa-biohazard"></i>
                            Climate risk
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('impacts')">
                            <i class="fas fa-bolt"></i>
                            Climate impacts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('practices')">
                            <i class="fas fa-child"></i>
                            Practices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="click_tab('enablers')">
                            <i class="fas fa-code-branch"></i>
                            Enablers
                        </a>
                    </li>
                </ul>
                <form class="d-flex">
                    <h2 class="navbar-brand">Location: <strong><span id="txt_site_selected"></span></strong></h2>
                </form>
            </div>
        </nav>
    </header>


    <main role="main" class="flex-shrink-0">
        <div class="container">
            <!-- Start Intro -->
            <div id="intro" style="margin-top: 70px;" class="tab_layout">
                <div class="row">
                    <div class="row row-cols-1 row-cols-sm-2 g-2">
                        <div class="col">
                            <div class="card shadow-sm">
                                <img src="https://ciat-dapa.github.io/pakistan_web/img/logos/l_fao.png" width="100%"
                                    height="225px" role="img" class="img-fluid" alt="FAO" />
                            </div>
                        </div>
                        <div class="col">
                            <div class="card shadow-sm">
                                <img src="https://ciat-dapa.github.io/pakistan_web/img/logos/l_alliance.png" width="100%"
                                    height="225px" role="img" class="img-fluid"
                                    alt="Alliance Bioversity International - CIAT" />
                            </div>
                        </div>                        
                    </div>
                </div>
                <h2>About the project</h2>
                <p class="text-justify">
                    The data presented in this dashboard is the output of a series of workshops and online consultations
                    conducted as part of a Food and Agriculture Organisation of the United Nations (FAO) led, and
                    Alliance of Bioversity International & CIAT designed project on Climate-Smart Agriculture in
                    Pakistan.
                    The project developed a series of District Climate Risk Profiles (DCRP's) and Climate Smart Village
                    (CSV) plans,
                    covering 13 districts and 43 villages from across Punjab, Sindh, and Khyber Pakhtunkhwa. The
                    implementation
                    of the project was supported by national partners in each of the three provinces, namely the Pir
                    Mehar Ali Shah (PMAS)
                    Arid Agriculture University Rawalpindi; the University of Agriculture Peshawar; and the Directorate
                    Training and
                    Research for Agriculture Engineering and Water management Sindh.
                </p>
                <p class="text-justify">
                    This dashboard acts as a centralised data store and visualisation tool for decision makers,
                    researchers
                    and agricultural practitioners to quickly access and review information gathered through this study,
                    based on consultations with over 1,000 agricultural experts and farmers from across the three
                    provinces.
                    We see this as an important tool in helping decision makers get a quick snap shot of the major
                    hazards,
                    their impacts, and recommended response strategies, supporting future policy and programming around
                    CSA
                    in Pakistan.
                </p>
                <p class="text-justify">
                    The authors of this study are extremely grateful for the contribution of all of those who took part
                    in the
                    study and helped to shed light on the importance of CSA in supporting Pakistan's agriculture sector.
                </p>
                <h3>How to use the dashboard</h3>
                <p class="text-justify">
                    <b>Site selection</b> - The first step in navigating through the dashboard is to select the region
                    you would like to look at.
                    This will allow you to either look at Pakistan as a whole, each of the three provinces or a single
                    district.
                    It is worth noting that depending on the type of information you are looking for some will be
                    available
                    aggregated at national or provincial levels, others will be available only at district or village
                    level.
                </p>
                <p class="text-justify">
                    <b>Cropping systems</b> - This tab displays district level data on production area and volume for
                    the major crops,
                    along with the livestock headcount. It also shows the cropping calendar and hazard calendar for the
                    villages
                    from that district covered in the study.
                </p>
                <p class="text-justify">
                    <b>Climate</b> - The climate tab presents the results of a number of modelling exercises conducted
                    by the
                    Alliance of Bioversity International and CIAT's modelling team. This includes climatology data on
                    monthly mean
                    precipitation, minimum and maximum temperatures, modelling of future annual mean temperatures and
                    precipitation
                    using an ensemble of Global Circulation Models (GCM's), and the historic and future time series of a
                    number of
                    climatic indicators that impact agricultural production.
                </p>
                <p class="text-justify">
                    <b>Climate risk</b> - This tab presents a risk matrix generated through responses from agricultural
                    experts
                    in the districts on the frequency and severity of major hazards.
                </p>
                <p class="text-justify">
                    <b>Climate Impacts</b> - This tab presents the results of the climate impact analysis where value
                    chain experts
                    in each of the districts identified the impacts of certain hazards on key commodity value chains for
                    the district.
                </p>
                <p class="text-justify">
                    <b>Practices</b> - Presents the types of CSA practices prioritised by experts in the district, along
                    with the
                    areas were they have an impact, the hazards they address, and the barriers to adoption.
                </p>
                <p class="text-justify">
                    <b>Enablers</b> - CSA enablers provide essential services and build core capacities, empowering
                    individuals
                    and agrarian communities to better manage their response to climate related pressures. This section
                    looks at which types of enabler are prioritised in each of the districts.
                </p>
            </div>
            <!-- End Intro-->

            <!-- Start General -->
            <div id="general">
                <h1 id="title" class="mt-5 text-center"></h1>
                <p id="description" class="text-justify"></p>
            </div>
            <!-- End General -->

            <!-- Start Site -->
            <div id="site" class="tab_layout">
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
            <!-- End Site -->

            <!-- Start Cropping -->
            <div id="cropping" class="tab_layout">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h2 id="cropping_title"></h2>
                </div>
                <h3>Production</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm">
                            <h4 class="text-center">Planted area</h4>
                            <div id="cropping_planted_plot" class="cropping_pie">
                                <svg></svg>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm">
                            <h4 class="text-center">Production</h4>
                            <div id="cropping_production_plot" class="cropping_pie">
                                <svg></svg>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm">
                            <h4 class="text-center">Livestock</h4>
                            <div id="cropping_livestock_plot" class="cropping_pie">
                                <svg></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div
                            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                            <h3>Village</h3>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group mr-2">
                                    <select id="cbo_village" class="form-control form-control-lg">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Cropping calendar</h3>
                        <table class="table table-sm">
                            <tr>
                                <td class="crop_c_Breeding">&nbsp;</td>
                                <td class="">Breeding</td>
                                <td class="crop_c_Growing">&nbsp;</td>
                                <td class="">Growing</td>
                                <td class="crop_c_Harvesting">&nbsp;</td>
                                <td class="">Harvesting</td>
                                <td class="crop_c_Planting">&nbsp;</td>
                                <td class="">Planting</td>
                            </tr>
                        </table>
                        <table id="cropping_calendar_table" class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Crop / Livestock</th>
                                    <th>Jan</th>
                                    <th>Feb</th>
                                    <th>Mar</th>
                                    <th>Apr</th>
                                    <th>May</th>
                                    <th>Jun</th>
                                    <th>Jul</th>
                                    <th>Aug</th>
                                    <th>Sep</th>
                                    <th>Oct</th>
                                    <th>Nov</th>
                                    <th>Dec</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Hazard calendar</h3>
                        <table id="cropping_hazard_table" class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Hazard</th>
                                    <th>Jan</th>
                                    <th>Feb</th>
                                    <th>Mar</th>
                                    <th>Apr</th>
                                    <th>May</th>
                                    <th>Jun</th>
                                    <th>Jul</th>
                                    <th>Aug</th>
                                    <th>Sep</th>
                                    <th>Oct</th>
                                    <th>Nov</th>
                                    <th>Dec</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- End Cropping -->

            <!-- Start Climate -->
            <div id="climate" class="tab_layout">
                <nav class="nav nav-tabs nav-justified" role="tablist" id="climate_tab">
                    <a class="nav-item nav-link active" id="cli_climatology_tab" data-toggle="tab"
                        href="#cli_climatology_content" role="tab" aria-controls="cli_climatology_content"
                        aria-selected="true">Climatology</a>
                    <a class="nav-item nav-link" id="cli_gcm_tab" data-toggle="tab" href="#cli_gcm_content" role="tab"
                        aria-controls="cli_gcm_content" aria-selected="false">GCM</a>
                    <a class="nav-item nav-link" id="cli_indicators_tab" data-toggle="tab"
                        href="#cli_indicators_content" role="tab" aria-controls="cli_indicators_content"
                        aria-selected="false">Indicators</a>
                </nav>
                <div class="tab-content" id="climate_content">
                    <div class="tab-pane fade show active" id="cli_climatology_content" role="tabpanel"
                        aria-labelledby="cli_climatology_tab">
                        <p class="text-justity">
                            For the figure below historical data is used to measure monthly mean precipitation and
                            maximum and minimum temperatures in the district.
                        </p>
                        <div class="row">
                            <div class="col-lg-6">
                                <div id="climate_prec_plot" class="climatology_plot">
                                    <svg></svg>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div id="climate_temp_plot" class="climatology_plot">
                                    <svg></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="cli_gcm_content" role="tabpanel" aria-labelledby="cli_gcm_tab">
                        <p class="text-justity">
                            Future climate data in the form of projected annual mean temperatures and precipitation was
                            modelled using the CMIP5 model ensemble.
                        </p>
                        <div class="row">
                            <div class="col-lg-6">
                                <div id="gcm_prec_plot" class="climatology_plot">
                                    <svg></svg>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div id="gcm_temp_plot" class="climatology_plot">
                                    <svg></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="cli_indicators_content" role="tabpanel"
                        aria-labelledby="cli_indicators_tab">
                        <p class="text-justity">
                            Given the sensitivity of crops to adverse climatic conditions modelling of future climatic
                            conditions needs to be more targeted to the growth requirements of crops, going beyond
                            yearly averages for temperatures and precipitation. To achieve this modelling was conducted
                            that focused on a set of indicators critical for plant and animal health. The indicators
                            used are described in the below table, with the analysis conducted for each of the Rabi and
                            Kharif seasons:
                        </p>
                        <table id="cli_indicators_list" class="table  table-sm">
                            <tr>
                                <th>Acronym</th>
                                <th>Description</th>
                                <th>Hazard</th>
                            </tr>
                            <tr>
                                <td>CDD</td>
                                <td>Drought spell. Maximum number of consecutive dry days (precipitation < 1 mm
                                        day-1).</td>
                                <td>Drought: there is a long drought spell during the growing season which reduces
                                    productivity or causes crop failure.</td>
                            </tr>
                            <tr>
                                <td>NDWS</td>
                                <td>Moisture stress. Number of days with ratio of actual to potential evapotranspiration
                                    ratio below 0.5.</td>
                                <td>Drought: crops experience wilting due to constantly low soil moisture levels during
                                    the growing season.</td>
                            </tr>
                            <tr>
                                <td>IRR</td>
                                <td>Irrigation water requirement. Total amount of required irrigation water to satisfy
                                    crop demand</td>
                                <td>Water scarcity: greater water requirements puts greater pressure on aquifers and
                                    rivers.</td>
                            </tr>
                            <tr>
                                <td>P5D</td>
                                <td>Flooding. Maximum 5-day running average precipitation.</td>
                                <td>Flooding: too much rainfall during a week causes flooding, which causes crops to
                                    wilt</td>
                            </tr>
                            <tr>
                                <td>NT35</td>
                                <td>Heat stress. Number of days with temperature above 35ºC.</td>
                                <td>Heat stress: many hot days during the growing period slow crop growth, hinder grain
                                    filling and can lead to low productivity.</td>
                            </tr>
                            <tr>
                                <td>P95</td>
                                <td>95th percentile of daily precipitation. Sows the level of precipitation recorded for
                                    extreme events</td>
                                <td>Flooding: Peak rainfall events increasing in intensity may result in flash flooding
                                </td>
                            </tr>
                        </table>
                        <div
                            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                            <h3>Indicators</h3>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group mr-2">
                                    <select id="cbo_climate_indicator" class="form-control form-control-lg">
                                    </select>
                                    <select id="cbo_climate_season" class="form-control form-control-lg">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div id="climate_indicator_plot" class="indicator_plot">
                                    <svg></svg>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div id="climate_indicator_map" class="indicator_map">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Climate -->

            <!-- Start CC Impacts -->
            <div id="impacts" class="tab_layout">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">                    
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group mr-2">
                            <select id="cbo_impact_crop" class="form-control form-control-lg">
                            </select>
                            <select id="cbo_impact_hazard" class="form-control form-control-lg">
                            </select>
                            <!-- <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                                -->
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div id="impacts_severity" class="col-md-12">
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="impacts_table" class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>1. Input</th>
                                <th>2. On-farm</th>
                                <th>3. Harvesting, storage & processing</th>
                                <th>4. Marketing</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
            <!-- End CC Impacts -->

            <!-- Start Risk -->
            <div id="risk" class="tab_layout">
                <div class="table-responsive">
                    <table id="risk_table" class="table  table-sm">
                        <tr>
                            <th>Severity / Frequency</th>
                            <th>Minor severity (<10% losses)</th>
                            <th>Moderate severity (10-30% losses)</th>
                            <th>Major severity (30-50% losses)</th>
                            <th>Severe severity (>50% losses)</th>
                        </tr>
                        <tr>
                            <th>Every 10 years</th>
                            <th id="r1-1" class="cell_green"></th>
                            <th id="r1-2" class="cell_green"></th>
                            <th id="r1-3" class="cell_yellow"></th>
                            <th id="r1-4" class="cell_orange"></th>
                        </tr>
                        <tr>
                            <th>Every 5 years</th>
                            <th id="r2-1" class="cell_green"></th>
                            <th id="r2-2" class="cell_yellow"></th>
                            <th id="r2-3" class="cell_yellow"></th>
                            <th id="r2-4" class="cell_orange"></th>
                        </tr>
                        <tr>
                            <th>Every second year</th>
                            <th id="r3-1" class="cell_yellow"></th>
                            <th id="r3-2" class="cell_yellow"></th>
                            <th id="r3-3" class="cell_orange"></th>
                            <th id="r3-4" class="cell_red"></th>
                        </tr>
                        <tr>
                            <th>Every year</th>
                            <th id="r4-1" class="cell_orange"></th>
                            <th id="r4-2" class="cell_orange"></th>
                            <th id="r4-3" class="cell_red"></th>
                            <th id="r4-4" class="cell_red"></th>
                        </tr>
                    </table>
                </div>
            </div>
            <!-- End Risk -->

            <!-- Start Practices -->
            <div id="practices" class="tab_layout">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">                    
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group mr-2">
                            <select id="cbo_practices_crop" class="form-control form-control-lg">
                            </select>
                            <select id="cbo_practices_hazard" class="form-control form-control-lg">
                            </select>
                            <!-- <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                                -->
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <div id="practices_table">

                    </div>
                </div>
            </div>
            <!-- End Practices -->

            <!-- Start Enablers -->
            <div id="enablers" class="tab_layout">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">                    
                    <div class="btn-toolbar mb-12 mb-md-0">
                        <div class="btn-group mr-2">
                            <label class="form-inline">
                                Select level of aggregation: 
                                <select id="cbo_enablers_agg" class="form-control form-control-lg" onchange="enablers_load()">
                                    <option value="dist">Districts</option>
                                    <option value="prov">Province</option>
                                    <option value="nati">National</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="enablers_table" class="table  table-sm">                        
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- End Enablers -->
        </div>
    </main>



    <footer class="text-muted">
        <div class="container">
            <p>© 2020 Alliance Bioversity International - CIAT</p>
        </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
        integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.min.js"></script>
    <script src="https://d3js.org/d3-color.v2.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>


    <script type="text/javascript">
        // Global function
        jQuery(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });

        $('#climate_tab a').on('click', function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            climate_load();
        })
        // Parameters
        var tab = 'intro';
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var color_indicator;
        var province = "";
        var district = "";
        var coords;
        var type_agg="";
        // Datasets
        var hazard_d = [];
        var practices_d = [];
        var climate_indicator_d = [];
        var climate_indicator_province = '';
        var climate_indicator_district = '';
        var climate_indicator_var = '';
        var climate_indicator_coords = [];
        var crop_c_full = [];
        var hazard_c_full = [];
        var tab = '';
        // Controls
        var map_i;
        var map;

        /**
        * This function change the type of information and functionalities of the web page depending of the value
        */
        function click_tab(tab_selected) {
            tab = tab_selected;
            $(".tab_layout").addClass("d-none");
            $("#general").removeClass("d-none");

            if (tab === 'intro') {
                $("#title").html("Intro");
                $("#description").html("");
                $(".tab_layout").addClass("d-none");
                $("#general").addClass("d-none");
                $("#intro").removeClass("d-none");
            }
            else if (tab === 'site') {
                $("#title").html("Site selection");
                $("#description").html("Please use the below map to select the region (National, Province, District) you would like to focus on. You can also see in the project site tab a list of all districts and villages included in the study.");
                $("#site").removeClass("d-none");
            }
            else if (tab === 'cropping') {
                $("#title").html("Cropping system");
                $("#description").html("In this tab you will find cropping and livestock data for each of the districts included in the study, based on the most recent provincial crop reporting data. Then for each of the villages in the province for which a CSV plan was prepared, you will find the cropping and hazard calendar constructed through village level consultations.");
                $("#cropping").removeClass("d-none");                
                d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/cropping/production.csv", function (error, data) {
                    var c_production = data.filter(function (item) { return item.district == district; });
                    d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/cropping/cropping_calendar.csv", function (error, data2) {
                        crop_c_full = data2.filter(function (item) { return item.district == district; });
                        d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/cropping/hazard.csv", function (error, data3) {
                            hazard_c_full = data3.filter(function (item) { return item.district == district; });
                            cropping_fill(c_production);

                            // Filling the cbo controls village
                            var village = d3.map(crop_c_full, function (d) { return d.village; }).keys();
                            var cbo_village = $("#cbo_village");
                            cbo_village.empty();
                            $.each(village, function () {
                                cbo_village.append($("<option />").val(this).text(this));
                            });

                            // Set the event change for both controls
                            cbo_village.on('change', function (e) {
                                var crop_c_f = crop_c_full.filter(function (item) { return item.village == cbo_village.val() });
                                var hazard_c_f = hazard_c_full.filter(function (item) { return item.village == cbo_village.val() });
                                cropping_calendar_hazard(crop_c_f, hazard_c_f);
                            });

                            var crop_c_f = crop_c_full.filter(function (item) { return item.village == cbo_village.val() });
                            var hazard_c_f = hazard_c_full.filter(function (item) { return item.village == cbo_village.val() });
                            cropping_calendar_hazard(crop_c_f, hazard_c_f);
                        });
                    });
                });
            }
            else if (tab === 'climate') {
                $("#title").html("Climate");
                $("#description").html('This tab presents the results of a number of modelling exercises conducted by the Alliance of Bioversity International and CIATs modelling team. This includes climatology data on monthly mean precipitation, minimum and maximum temperatures, modelling of future annual mean temperatures and precipitation using an ensemble of Global Circulation Models (GCMs), and the historic and future time series of a number of climatic indicators that impact agricultural production. For a breakdown of the modelling process please see modelling support doc through <a href="https://drive.google.com/file/d/1fXpeykS-ipEzR9NCBw1GeIXGORNMopZo/view" target="_blank">this link</a>.');
                $("#climate").removeClass("d-none"); 
                climate_load();
            }
            else if (tab === 'impacts') {
                $("#title").html("Climate impacts");
                $("#description").html("This tab presents the results of the climate impact analysis where value chain experts in each of the districts identified the impacts of certain hazards on key commodity value chains for the district. The impacts are ordered with those that were selected the most frequently at the top. It is possible to further filter the impacts looking at specific hazards of commodity value chains.");
                $("#impacts").removeClass("d-none");
                d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/impacts/impacts.csv", function (error, data) {
                    hazard_d = data.filter(function (item) { return item.district == district; });
                    // Filling the cbo controls with hazard and crops
                    var crops_livestock = d3.map(hazard_d, function (d) { return d.crop_livestock; }).keys();
                    var cbo_impact_crop = $("#cbo_impact_crop");
                    cbo_impact_crop.empty();
                    $.each(crops_livestock, function () {
                        cbo_impact_crop.append($("<option />").val(this).text(this));
                    });
                    cbo_impact_crop.append($("<option />").val("All").text("All"));
                    cbo_impact_crop.val("All");

                    var hazard = d3.map(hazard_d, function (d) { return d.hazard; }).keys();
                    var cbo_impact_hazard = $("#cbo_impact_hazard");
                    cbo_impact_hazard.empty();
                    $.each(hazard, function () {
                        cbo_impact_hazard.append($("<option />").val(this).text(this));
                    });
                    cbo_impact_hazard.append($("<option />").val("All").text("All"));
                    cbo_impact_hazard.val("All");

                    // Set the event change for both controls
                    cbo_impact_crop.on('change', function (e) {
                        impact_fill_table(cbo_impact_crop.val(), cbo_impact_hazard.val());
                    });
                    cbo_impact_hazard.on('change', function (e) {
                        impact_fill_table(cbo_impact_crop.val(), cbo_impact_hazard.val());
                    });

                    // Default fill
                    impact_fill_table(cbo_impact_crop.val(), cbo_impact_hazard.val());
                });
            }
            else if (tab === 'risk') {
                $("#title").html("Climate risk");
                $("#description").html("This tab presents a risk matrix generated through responses from agricultural experts in the districts on the frequency and severity of major hazards.");
                $("#risk").removeClass("d-none");                
                d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/risk/risk.csv", function (error, data) {
                    var risk_d = data.filter(function (item) { return item.district == district; });
                    risk_fill(risk_d);
                });
            }
            else if (tab === 'practices') {
                $("#title").html("Practices");
                $("#description").html("This tab presents the types of CSA practices prioritised by experts in the district, along with the areas were they have an impact, the hazards they address, and the barriers to adoption. the practices can be filtered by the commodity they look at, the areas where they have an impact or the types of hazards they address, allowing decision makers to identify practices that address certain priority issues.");
                $("#practices").removeClass("d-none");                
                d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/practices/practices.csv", function (error, data) {
                    practices_d = data.filter(function (item) { return item.district == district; });

                    // Filling the cbo controls with hazard and crops  
                    var crop = Array.from(new Set(d3.map(practices_d, function (d) { return d.crop; }).keys()));
                    var cbo_practices_crop = $("#cbo_practices_crop");
                    cbo_practices_crop.empty();
                    crop.forEach(function (i, v) {
                        cbo_practices_crop.append($("<option />").val(i).text(i));
                    });
                    cbo_practices_crop.append($("<option />").val("All").text("All"));
                    cbo_practices_crop.val("All");

                    var hazard = Array.from(new Set(d3.map(practices_d, function (d) { return d.hazard; }).keys()));
                    var cbo_practices_hazard = $("#cbo_practices_hazard");
                    cbo_practices_hazard.empty();
                    hazard.forEach(function (i, v) {
                        cbo_practices_hazard.append($("<option />").val(i).text(i));
                    });
                    cbo_practices_hazard.append($("<option />").val("All").text("All"));
                    cbo_practices_hazard.val("All");

                    // Set the event change for both controls
                    cbo_practices_crop.on('change', function (e) {
                        practices_fill(cbo_practices_crop.val(), cbo_practices_hazard.val());
                    });
                    cbo_practices_hazard.on('change', function (e) {
                        practices_fill(cbo_practices_crop.val(), cbo_practices_hazard.val());
                    });

                    // Default fill
                    practices_fill(cbo_practices_crop.val(), cbo_practices_hazard.val());
                });
            }
            else if (tab === 'enablers') {
                $("#title").html("Enablers");
                $("#description").html("CSA enablers provide essential services and build core capacities, empowering individuals and agrarian communities to better manage their response to climate related pressures. This section looks at which types of enabler are prioritised in each of the districts.");
                $("#enablers").removeClass("d-none");
                enablers_load();
            }

            if (map != null) {
                map.off();
                map.remove();
            }

            map = L.map('map').setView([29.8724623, 66.1822339], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var layer_url = "https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/maps/pakistan_map.json";
            $.getJSON(layer_url, function (data) {
                L.geoJSON(data, { onEachFeature: onEachFeature }).addTo(map);
            });
        }

        /**
        * Function which fill cropping data
        */
        function cropping_fill(production) {
            // Clear chart
            $("#cropping_planted_plot svg").html("");
            $("#cropping_production_plot svg").html("");
            $("#cropping_livestock_plot svg").html("");
            // Filtering data
            var d_pl = production.filter(function (d) { return d.sector == 'Crops'; }).map(function (d) { return { "label": d.crop_livestock, "value": parseFloat(d.value) } });
            var d_pr = production.filter(function (d) { return d.sector == 'Production'; }).map(function (d) { return { "label": d.crop_livestock, "value": parseFloat(d.value) } });
            var d_li = production.filter(function (d) { return d.sector == 'Livestock'; }).map(function (d) { return { "label": d.crop_livestock, "value": parseFloat(d.value) } });

            var colors_pie = ["#6e4c1f", "#9d9fa2", "#0088c6", "#8ebf3f", "#cad32b", "#f5d226", "#f68b33", "#993399", "#009933", "#cc3333", "#414042", "#2f8927", "#003580", "#19191a"];
            // Production plots
            nv.addGraph(function () {
                var d_pl_chart = nv.models.pieChart()
                    .x(function (d) { return d.label })
                    .y(function (d) { return d.value })
                    .color(colors_pie)
                    .showLabels(true);

                d3.select("#cropping_planted_plot svg")
                    .datum(d_pl)
                    .transition().duration(1200)
                    .call(d_pl_chart);

                return d_pl_chart;
            });
            nv.addGraph(function () {
                var d_pr_chart = nv.models.pieChart()
                    .x(function (d) { return d.label })
                    .y(function (d) { return d.value })
                    .color(colors_pie)
                    .showLabels(true);

                d3.select("#cropping_production_plot svg")
                    .datum(d_pr)
                    .transition().duration(1200)
                    .call(d_pr_chart);

                return d_pr_chart;
            });
            nv.addGraph(function () {
                var d_li_chart = nv.models.pieChart()
                    .x(function (d) { return d.label })
                    .y(function (d) { return d.value })
                    .color(colors_pie)
                    .showLabels(true);

                d3.select("#cropping_livestock_plot svg")
                    .datum(d_li)
                    .transition().duration(1200)
                    .call(d_li_chart);

                return d_li_chart;
            });
        }

        /**
        * Function which fill cropping data about calendar and hazard
        */
        function cropping_calendar_hazard(crop_c, hazard_c) {
            // Cropping calendar
            var crops = Array.from(new Set(crop_c.map(function (d) { return d.crop_livestock; })));
            var table = '';
            $.each(crops, function (index, value) {
                table = table + '<tr>';
                table = table + '<td>' + value + '</td>';
                $.each(months, function (i, v) {
                    var cell = crop_c.filter(function (d) { return d.crop_livestock == value && d.month == v })[0];
                    table = table + '<td class="crop_c_' + cell.value + '" ' +
                        'data-toggle="tooltip" ' +
                        //'data-position="bottom" '  + 
                        'title="' + cell.practices + '"></td>';
                    //'data-tooltip="' + cell.practices + '"></td>';
                });
                table = table + '</tr>';
            });
            //table = table + '</table>';
            $("#cropping_calendar_table  > tbody").html(table);

            // Hazard calendar
            var hazards = Array.from(new Set(hazard_c.map(function (d) { return d.hazard; })));
            table = '';
            $.each(hazards, function (index, value) {
                table = table + '<tr>';
                table = table + '<td>' + value + '</td>';
                $.each(months, function (i, v) {
                    table = table + '<td class="text-center text-danger">' + hazard_c.filter(function (d) { return d.hazard == value && d.month == v })[0].value + '</td>';
                });
                table = table + '</tr>';
            });
            //table = table + '</table>';
            $("#cropping_hazard_table  > tbody").html(table);
        }
        
        /**
         * Function which loads and draws all plots for climate section
        */
        function climate_load(){
            d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/climate/climatology.csv", function (error, data) {
                    var climatology = data.filter(function (item) { return item.district == district; });
                    d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/climate/gcm.csv", function (error, data2) {
                        var gcm = data2.filter(function (item) { return item.district == district; });

                        climate_fill(climatology, gcm);

                        d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/climate/indicators.csv", function (error, data3) {
                            climate_indicator_d = data3.filter(function (item) { return item.district == district; });

                            climate_indicator_province = province;
                            climate_indicator_district = district;
                            climate_indicator_coords = coords;

                            // Filling the cbo controls with hazard and crops
                            var indicators = d3.map(climate_indicator_d, function (d) { return d.vars; }).keys();
                            var cbo_climate_indicator = $("#cbo_climate_indicator");
                            cbo_climate_indicator.empty();
                            $.each(indicators, function () {
                                cbo_climate_indicator.append($("<option />").val(this).text(this.toUpperCase()));
                            });

                            var season = d3.map(climate_indicator_d, function (d) { return d.season; }).keys();
                            var cbo_climate_season = $("#cbo_climate_season");
                            cbo_climate_season.empty();
                            $.each(season, function () {
                                cbo_climate_season.append($("<option />").val(this).text(this));
                            });

                            // Set the event change for both controls
                            cbo_climate_indicator.on('change', function (e) {
                                climate_indicator_fill(cbo_climate_indicator.val(), cbo_climate_season.val());
                            });
                            cbo_climate_season.on('change', function (e) {
                                climate_indicator_fill(cbo_climate_indicator.val(), cbo_climate_season.val());
                            });

                            // Default fill
                            climate_indicator_fill(cbo_climate_indicator.val(), cbo_climate_season.val());
                        });
                    });
                });
        }
        
        /**
        * Function which fill climate data
        */
        function climate_fill(climatology, gcm) {
            // Clear chart
            $(".climatology_plot svg").html("");
            // Climatology
            var c_p = [{
                values: climatology.map(function (item) {
                    return {
                        x: parseInt(item.month),
                        y: parseFloat(item.prec)
                    }
                }),      //values - represents the array of {x,y} data points                
                key: 'Precipitation', //key  - the name of the series.
                color: '#596dad'  //color - optional: choose your own line color.
            }]
            var c_t = [{
                values: climatology.map(function (item) {
                    return {
                        x: parseInt(item.month),
                        y: parseFloat(item.tmax)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'Maximum temperature', //key  - the name of the series.
                color: '#e34147'  //color - optional: choose your own line color.
            },
            {
                values: climatology.map(function (item) {
                    return {
                        x: parseInt(item.month),
                        y: parseFloat(item.tmin)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'Minimum temperature', //key  - the name of the series.
                color: '#e5d900'  //color - optional: choose your own line color.
            }];

            //console.log(c_p);

            nv.addGraph(function () {
                var chart_pre = nv.models.multiBarChart()
                    .stacked(true)
                    //.useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!                      
                    .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                    .staggerLabels(false)
                    .showControls(false)
                    //.showValues(true)
                    .color(['#596dad'])
                    ;

                chart_pre.xAxis     //Chart x-axis settings
                    .axisLabel('Months')
                    .tickFormat(function (d, i) {
                        return months[d - 1];
                    });

                chart_pre.yAxis     //Chart y-axis settings
                    .axisLabel('Precipitation (mm)')
                    .tickFormat(d3.format('.0f'));

                d3.select('#climate_prec_plot svg')    //Select the <svg> element you want to render the chart in.   
                    .datum(c_p)         //Populate the <svg> element with chart data...
                    .transition().duration(500)
                    .call(chart_pre);          //Finally, render the chart!

                //Update the chart when window resizes.

                nv.utils.windowResize(function () { chart_pre.update() });
                return chart_pre;
            });

            nv.addGraph(function () {
                var chart_tem = nv.models.lineChart()
                    .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!                      
                    .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                    ;

                chart_tem.xAxis     //Chart x-axis settings
                    .axisLabel('Months')
                    .tickFormat(function (d, i) {
                        return months[d - 1];
                    });

                chart_tem.yAxis     //Chart y-axis settings
                    .axisLabel('Temperature (°C)')
                    .tickFormat(d3.format('.0f'));

                d3.select('#climate_temp_plot svg')    //Select the <svg> element you want to render the chart in.   
                    .datum(c_t)         //Populate the <svg> element with chart data...
                    .transition().duration(500)
                    .call(chart_tem);          //Finally, render the chart!

                //Update the chart when window resizes.
                nv.utils.windowResize(function () { chart_tem.update() });
                return chart_tem;
            });

            // GCM
            var g_p = [{
                values: gcm.map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.prec)
                    }
                }),      //values - represents the array of {x,y} data points                
                key: 'Precipitation', //key  - the name of the series.
                color: '#596dad'  //color - optional: choose your own line color.
            }]
            var g_t = [{
                values: gcm.map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.tmean)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'Temperature', //key  - the name of the series.
                color: '#e34147'  //color - optional: choose your own line color.
            }];

            nv.addGraph(function () {
                var gcm_pre = nv.models.lineChart()
                    .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!                      
                    .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                    ;

                gcm_pre.xAxis     //Chart x-axis settings
                    .axisLabel('Year')
                    //.tickFormat(d3.format('.0f'))
                    ;

                gcm_pre.yAxis     //Chart y-axis settings
                    .axisLabel('Precipitation (mm)')
                    .tickFormat(d3.format('.0f'));


                d3.select('#gcm_prec_plot svg')    //Select the <svg> element you want to render the chart in.   
                    .datum(g_p)         //Populate the <svg> element with chart data...
                    .transition().duration(500)
                    .call(gcm_pre);          //Finally, render the chart!

                //Update the chart when window resizes.
                nv.utils.windowResize(function () { gcm_pre.update() });
                return gcm_pre;
            });
            nv.addGraph(function () {
                var gcm_tem = nv.models.lineChart()
                    .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!                      
                    .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                    ;

                gcm_tem.xAxis     //Chart x-axis settings
                    .axisLabel('Year')
                    //.tickFormat(d3.format('.0f'))
                    ;

                gcm_tem.yAxis     //Chart y-axis settings
                    .axisLabel('Temperature (°C)')
                    .tickFormat(d3.format('.0f'));


                d3.select('#gcm_temp_plot svg')    //Select the <svg> element you want to render the chart in.   
                    .datum(g_t)         //Populate the <svg> element with chart data...
                    .transition().duration(500)
                    .call(gcm_tem);          //Finally, render the chart!

                //Update the chart when window resizes.
                nv.utils.windowResize(function () { gcm_tem.update() });
                return gcm_tem;
            });
        }

        /**
        * Function which fill the indicators for climate
        */
        function climate_indicator_fill(indicator, season) {
            // Clear chart
            $(".indicator_plot svg").html("");
            $("#climate_indicator_map").html("");
            // Set global vars
            climate_indicator_var = indicator;

            var i_i = climate_indicator_d.filter(function (d) { return d.season == season && d.vars == indicator });
            var i_p = [{
                values: i_i.filter(function (d) { return d.time == 'past' }).map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.value)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'Past', //key  - the name of the series.
                color: '#ffbe7d'  //color - optional: choose your own line color.
            },
            {
                values: i_i.filter(function (d) { return d.time == 'future' }).map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.value)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'Future', //key  - the name of the series.
                color: '#4e79a7'  //color - optional: choose your own line color.
            },
            {
                values: i_i.filter(function (d) { return d.time == 'future' }).map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.CI_lower)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'CI lower', //key  - the name of the series.
                color: '#75a1c7'  //color - optional: choose your own line color.
            },
            {
                values: i_i.filter(function (d) { return d.time == 'future' }).map(function (item) {
                    return {
                        x: parseInt(item.year),
                        y: parseFloat(item.CI_upper)
                    }
                }),      //values - represents the array of {x,y} data points
                key: 'CI upper', //key  - the name of the series.
                color: '#75a1c7'  //color - optional: choose your own line color.
            }];

            nv.addGraph(function () {
                var ind_p = nv.models.lineChart()
                    .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!                      
                    .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                    ;

                ind_p.xAxis     //Chart x-axis settings
                    .axisLabel('Year')
                    //.tickFormat(d3.format('.0f'))
                    ;

                ind_p.yAxis     //Chart y-axis settings
                    .axisLabel('Value')
                    .tickFormat(d3.format('.0f'));


                d3.select('#climate_indicator_plot svg')    //Select the <svg> element you want to render the chart in.   
                    .datum(i_p)         //Populate the <svg> element with chart data...
                    .call(ind_p);          //Finally, render the chart!

                //Update the chart when window resizes.
                nv.utils.windowResize(function () { ind_p.update() });
                return ind_p;
            });

            if (map_i != null) {
                map_i.off();
                map_i.remove();
            }
            map_i = L.map('climate_indicator_map').setView([climate_indicator_coords[1], climate_indicator_coords[0]], 7);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map_i);

            var min = d3.min(i_i, function (d) { return parseFloat(d.value); });
            var max = d3.max(i_i, function (d) { return parseFloat(d.value); });
            color_indicator = d3.scale.linear()
                .domain([min, max])
                .range([0, 1]);

            var indicator_url = "https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/climate/" + season + "_new_version.json";
            $.getJSON(indicator_url, function (data) {
                L.geoJSON(data, { filter: filter_map, onEachFeature: onEachFeature2, weight: 0.5 }).addTo(map_i);
            });

            var legend = L.control({ position: 'topright' });
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                div.innerHTML += '<h4>Scale (' + climate_indicator_var + ')</h4>' +
                    '<div id="map_scale"><svg></svg></div>';
                return div;
            };
            legend.addTo(map_i);

            var range = d3.range(min, max, (max - min) / 100);
            var svg = d3.select("#map_scale svg");
            var rects = svg.selectAll(".rects")
                .data(range)
                .enter()
                .append("rect")
                .attr("y", 10)
                .attr("height", 25)
                .attr("x", (d, i) => 10 + i)
                .attr("width", 6)
                .attr("fill", function (d) { return "" + d3.interpolateOranges(color_indicator(d)); });

            svg.append("text")
                //.attr("x", function(d) { return x(d) - 3; })
                .attr("y", 7)
                .attr("dy", ".35em")
                .text(function (d) { return min; });
            svg.append("text")
                .attr("x", 110)
                .attr("y", 7)
                .attr("dy", ".35em")
                .text(function (d) { return max; });
        }

        function filter_map(feature) {
            if (feature.properties.county == climate_indicator_district) return true;
        }

        function onEachFeature2(feature, layer) {
            layer.setStyle({
                fillColor: d3.interpolateOranges(color_indicator(feature.properties[climate_indicator_var])),
                fillOpacity: 0.8,
                weight: 0.5
            });
            layer.on('click', function (e) {

            });
        }

        function color_impact(value) {
            return value >= 60 ? 'class="table-danger"' : (value < 60 && value >= 30 ? 'class="table-warning"' : '');
        }
        /**
        * Function which filter dataset for impacts and show data into the table
        */
        function impact_fill_table(crop, hazard) {
            var filter_level = crop != 'All' && hazard != 'All';
            // Filtering data and order by frequency
            var inputs = hazard_d.filter(function (item) { return item.vc_stage == '1. Input' && (crop == 'All' ? true : item.crop_livestock == crop) && (hazard == 'All' ? true : item.hazard == hazard) }).sort((a, b) => d3.descending(parseFloat(a.freq), parseFloat(b.freq)));
            var on_farm = hazard_d.filter(function (item) { return item.vc_stage == '2. On-farm' && (crop == 'All' ? true : item.crop_livestock == crop) && (hazard == 'All' ? true : item.hazard == hazard) }).sort((a, b) => d3.descending(parseFloat(a.freq), parseFloat(b.freq)));
            var harvesting = hazard_d.filter(function (item) { return item.vc_stage == '3. Harvesting, storage & processing' && (crop == 'All' ? true : item.crop_livestock == crop) && (hazard == 'All' ? true : item.hazard == hazard) }).sort((a, b) => d3.descending(parseFloat(a.freq), parseFloat(b.freq)));
            var marketing = hazard_d.filter(function (item) { return item.vc_stage == '4. Marketing' && (crop == 'All' ? true : item.crop_livestock == crop) && (hazard == 'All' ? true : item.hazard == hazard) }).sort((a, b) => d3.descending(parseFloat(a.freq), parseFloat(b.freq)));
            var severity = hazard_d.filter(function (item) { return item.crop_livestock == crop && item.hazard == hazard });
            severity = d3.map(severity, function (d) { return d.severity; }).keys();
            var count = hazard_d.filter(function (item) { return item.crop_livestock == crop && item.hazard == hazard });
            count = d3.map(count, function (d) { return d.count; }).keys();

            // Fixing groups and Removing duplicates
            //console.log(inputs);
            inputs = d3.nest()
                .key(function (d) { return d.impact; })
                .rollup(function (v) { return d3.mean(v, function (k) { return parseFloat(k.percentage); }) })
                .entries(inputs).filter(function (d) { return d.values > 20 });
            on_farm = d3.nest()
                .key(function (d) { return d.impact; })
                .rollup(function (v) { return d3.mean(v, function (k) { return parseFloat(k.percentage); }) })
                .entries(on_farm).filter(function (d) { return d.values > 20 });
            harvesting = d3.nest()
                .key(function (d) { return d.impact; })
                .rollup(function (v) { return d3.mean(v, function (k) { return parseFloat(k.percentage); }) })
                .entries(harvesting).filter(function (d) { return d.values > 20 });
            marketing = d3.nest()
                .key(function (d) { return d.impact; })
                .rollup(function (v) { return d3.mean(v, function (k) { return parseFloat(k.percentage); }) })
                .entries(marketing).filter(function (d) { return d.values > 20 });
            //console.log(inputs);
            // Fixing data in the table
            var max = d3.max([d3.max([d3.max([inputs.length, on_farm.length]), harvesting.length]), marketing.length]);
            var table = '';
            for (var i = 0; i < max; i++) {
                table = table + '<tr>';
                table = table + (inputs.length > i ? '<td ' + (filter_level ? color_impact(inputs[i].values) : '') + '>' + inputs[i].key + '</td>' : '<td></td>');
                table = table + (on_farm.length > i ? '<td ' + (filter_level ? color_impact(on_farm[i].values) : '') + '>' + on_farm[i].key + '</td>' : '<td></td>');
                table = table + (harvesting.length > i ? '<td ' + (filter_level ? color_impact(harvesting[i].values) : '') + '>' + harvesting[i].key + '</td>' : '<td></td>');
                table = table + (marketing.length > i ? '<td ' + (filter_level ? color_impact(marketing[i].values) : '') + '>' + marketing[i].key + '</td>' : '<td></td>');
                table = table + '</tr>';
            }
            //table = table + '</table>';
            $("#impacts_table  > tbody").html(table);

            // Sverity
            if (severity.length > 0) {
                table = '<table class="table table-striped table-sm">';
                for (var i = 0; i < severity.length; i++) {
                    table = table + '<tr><th>Severity</th><td>' + severity[i] + '</td><th>Count</th><td>' + count[i] + '</td></tr>';
                }
                table = table + '</table>';
                $("#impacts_severity").html(table);
            }
            else {
                $("#impacts_severity").html("");
            }
        }

        /**
        * Function which filter dataset for practices and show data into the table
        */
        function practices_fill(crop, hazard) {
            // Filtering data
            var records = practices_d.filter(function (item) { return (crop == 'All' ? true : item.crop == crop) && (hazard == 'All' ? true : item.hazard == hazard || item.hazard_1 == hazard || item.hazard_2 == hazard || item.hazard_3 == hazard) });

            //var table = '';
            var table = '<table class="table table-bordered table-sm">';
            for (var i = 0; i < records.length; i++) {
                table = table + '<tr class="table-secondary d-flex">';
                table = table + '<td class="col-1 text-center"><span class="practices_id">' + records[i].Order + '</span></td>';
                table = table + '<td class="col-2"><h4>' + records[i].crop + '</h4><p class="text-justify">' + records[i].csa + '</p><p class="text-warning"><b>' + records[i].adoption + '</b></p></td>';
                table = table + '<td class="col-5"><table class="table borderless"><tr><td>' +
                    (records[i].ind_1 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_1 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_1 + '" />') +
                    (records[i].ind_2 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_2 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_2 + '" />') +
                    (records[i].ind_3 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_3 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_3 + '" />') +
                    (records[i].ind_4 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_4 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_4 + '" />') +
                    (records[i].ind_5 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_5 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_5 + '" />') +
                    (records[i].ind_6 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/indicators/' + records[i].ind_6 + '.png" class="rounded practices_img_icons" alt="' + records[i].ind_6 + '" />') +
                    '</td></tr>';
                table = table + '<tr><td>' +
                    (records[i].hazard == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/hazards/' + records[i].hazard + '.png" class="rounded practices_img_icons" alt="' + records[i].hazard + '" />') +
                    (records[i].hazard_1 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/hazards/' + records[i].hazard_1 + '.png" class="rounded practices_img_icons" alt="' + records[i].hazard_1 + '" />') +
                    (records[i].hazard_2 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/hazards/' + records[i].hazard_2 + '.png" class="rounded practices_img_icons" alt="' + records[i].hazard_2 + '" />') +
                    (records[i].hazard_3 == '' ? '' : '<img src="https://ciat-dapa.github.io/pakistan_web/img/hazards/' + records[i].hazard_3 + '.png" class="rounded practices_img_icons" alt="' + records[i].hazard_3 + '" />') +
                    '</td></tr></table></td>';
                table = table + '<td class="col-4"><table class="table borderless">';
                if (records[i].barrier_1 != '')
                    table = table + '<tr><td><img src="https://ciat-dapa.github.io/pakistan_web/img/barriers/' + records[i].barrier_1 + '.png" class="rounded practices_img_icons" alt="' + records[i].barrier_1 + '" /></td>' +
                        '<td>' + records[i].b1_exp + '</td></tr>';
                if (records[i].barrier_2 != '')
                    table = table + '<tr><td><img src="https://ciat-dapa.github.io/pakistan_web/img/barriers/' + records[i].barrier_2 + '.png" class="rounded practices_img_icons" alt="' + records[i].barrier_2 + '" /></td>' +
                        '<td>' + records[i].b2_exp + '</td></tr>';
                table = table + '</table></td>';
                table = table + '</tr>';

            }
            //table = table + '</div>';
            $("#practices_table").html(table);
        }

        /**
        * Function which fill table of risk for climate risk
        */
        function risk_fill(data) {
            for (var i = 1; i < 5; i++) {
                for (var j = 1; j < 5; j++) {
                    $("#r" + i + '-' + j).html("");
                }
            }
            data.forEach(element => {
                var key = "#r" + element.frequency + '-' + element.severity;
                if (element.severity != '#N/A' && element.frequency != '#N/A') {
                    $(key).html($(key).html() + '- ' + element.hazard + '<br />')
                }
            });
        }

        function enablers_load(){            
            type_agg = $("#cbo_enablers_agg").val();            
            d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/enablers/enablers_" + type_agg +".csv", function (error, data) {                
                var enablers = null;
                if(type_agg === 'dist')
                    enablers = data.filter(function (item) { return item.district == district; });
                else if(type_agg === 'prov')
                    enablers = data.filter(function (item) { return item.province == province; });
                else
                    enablers = data;
                console.log(enablers);
                enablers = enablers.sort((a, b) => d3.descending(parseFloat(a.rank), parseFloat(b.rank)));
                //enablers = data;                    
                // Default fill
                enablers_fill(enablers);
            });
        }
        /**
        * Function which fill table of enablers
        */
        function enablers_fill(data){
            table = "";
            $("#enablers_table  > tbody").html(table);
            for(var item in data) {                
                table = table + '<tr>';
                table = table + '<th>' + data[item].type + '</th>';
                table = table + '<td>' + data[item].name + '</td>';
                table = table + '<td>' + data[item].description + '</td>';
                table = table + '</tr>';
            }
            //table = table + '</table>';
            $("#enablers_table  > tbody").html(table);
        }
        /**
        * Function for each feature into the map
        */
        function onEachFeature(feature, layer) {
            d3.csv("https://raw.githubusercontent.com/CIAT-DAPA/pakistan_web/master/data/maps/pakistan_data.csv", function (error, data) {
                var district = data.filter(function (item) { return item.NAME_3 == layer.feature.properties.NAME_3; });
                layer.setStyle({
                    fillColor: district.length > 0 && district[0][tab] == '1' ? "#0099e6" : "#a6a6a6",
                    fillOpacity: 0.8,
                    weight: 0.5
                });

            });

            layer.on('click', function (e) {
                province = layer.feature.properties.NAME_1;
                district = layer.feature.properties.NAME_3;
                coords = layer.feature.geometry.coordinates[0][0];

                $("#txt_site_selected").html(province + " - " + district);
            });
        }

        // Default tab
        click_tab('intro');

    </script>
</body>

</html>